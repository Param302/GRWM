"""
Tech Stack Badge Mapping for shields.io
Based on: https://github.com/Ileriayo/markdown-badges
"""

# Comprehensive mapping of tech stacks to shields.io badges
# Format: "tech_name": {"badge": "markdown_badge_url", "name": "Display Name"}

TECH_STACK_BADGES = {
    # Programming Languages
    "python": {"badge": "https://img.shields.io/badge/python-3670A0?style=for-the-badge&logo=python&logoColor=ffdd54", "name": "Python"},
    "javascript": {"badge": "https://img.shields.io/badge/javascript-%23323330.svg?style=for-the-badge&logo=javascript&logoColor=%23F7DF1E", "name": "JavaScript"},
    "typescript": {"badge": "https://img.shields.io/badge/typescript-%23007ACC.svg?style=for-the-badge&logo=typescript&logoColor=white", "name": "TypeScript"},
    "java": {"badge": "https://img.shields.io/badge/java-%23ED8B00.svg?style=for-the-badge&logo=openjdk&logoColor=white", "name": "Java"},
    "c": {"badge": "https://img.shields.io/badge/c-%2300599C.svg?style=for-the-badge&logo=c&logoColor=white", "name": "C"},
    "c++": {"badge": "https://img.shields.io/badge/c++-%2300599C.svg?style=for-the-badge&logo=c%2B%2B&logoColor=white", "name": "C++"},
    "c#": {"badge": "https://img.shields.io/badge/c%23-%23239120.svg?style=for-the-badge&logo=csharp&logoColor=white", "name": "C#"},
    "go": {"badge": "https://img.shields.io/badge/go-%2300ADD8.svg?style=for-the-badge&logo=go&logoColor=white", "name": "Go"},
    "rust": {"badge": "https://img.shields.io/badge/rust-%23000000.svg?style=for-the-badge&logo=rust&logoColor=white", "name": "Rust"},
    "ruby": {"badge": "https://img.shields.io/badge/ruby-%23CC342D.svg?style=for-the-badge&logo=ruby&logoColor=white", "name": "Ruby"},
    "php": {"badge": "https://img.shields.io/badge/php-%23777BB4.svg?style=for-the-badge&logo=php&logoColor=white", "name": "PHP"},
    "swift": {"badge": "https://img.shields.io/badge/swift-F54A2A?style=for-the-badge&logo=swift&logoColor=white", "name": "Swift"},
    "kotlin": {"badge": "https://img.shields.io/badge/kotlin-%237F52FF.svg?style=for-the-badge&logo=kotlin&logoColor=white", "name": "Kotlin"},
    "dart": {"badge": "https://img.shields.io/badge/dart-%230175C2.svg?style=for-the-badge&logo=dart&logoColor=white", "name": "Dart"},
    "r": {"badge": "https://img.shields.io/badge/r-%23276DC3.svg?style=for-the-badge&logo=r&logoColor=white", "name": "R"},
    "scala": {"badge": "https://img.shields.io/badge/scala-%23DC322F.svg?style=for-the-badge&logo=scala&logoColor=white", "name": "Scala"},
    "shell": {"badge": "https://img.shields.io/badge/shell_script-%23121011.svg?style=for-the-badge&logo=gnu-bash&logoColor=white", "name": "Shell Script"},
    "lua": {"badge": "https://img.shields.io/badge/lua-%232C2D72.svg?style=for-the-badge&logo=lua&logoColor=white", "name": "Lua"},

    # Frontend Frameworks
    "react": {"badge": "https://img.shields.io/badge/react-%2320232a.svg?style=for-the-badge&logo=react&logoColor=%2361DAFB", "name": "React"},
    "vue": {"badge": "https://img.shields.io/badge/vue.js-%2335495e.svg?style=for-the-badge&logo=vuedotjs&logoColor=%234FC08D", "name": "Vue.js"},
    "vue.js": {"badge": "https://img.shields.io/badge/vue.js-%2335495e.svg?style=for-the-badge&logo=vuedotjs&logoColor=%234FC08D", "name": "Vue.js"},
    "angular": {"badge": "https://img.shields.io/badge/angular-%23DD0031.svg?style=for-the-badge&logo=angular&logoColor=white", "name": "Angular"},
    "svelte": {"badge": "https://img.shields.io/badge/svelte-%23f1413d.svg?style=for-the-badge&logo=svelte&logoColor=white", "name": "Svelte"},
    "next.js": {"badge": "https://img.shields.io/badge/Next-black?style=for-the-badge&logo=next.js&logoColor=white", "name": "Next.js"},
    "nuxt": {"badge": "https://img.shields.io/badge/Nuxt-002E3B?style=for-the-badge&logo=nuxtdotjs&logoColor=#00DC82", "name": "Nuxt.js"},
    "gatsby": {"badge": "https://img.shields.io/badge/Gatsby-%23663399.svg?style=for-the-badge&logo=gatsby&logoColor=white", "name": "Gatsby"},

    # Backend Frameworks
    "django": {"badge": "https://img.shields.io/badge/django-%23092E20.svg?style=for-the-badge&logo=django&logoColor=white", "name": "Django"},
    "flask": {"badge": "https://img.shields.io/badge/flask-%23000.svg?style=for-the-badge&logo=flask&logoColor=white", "name": "Flask"},
    "fastapi": {"badge": "https://img.shields.io/badge/FastAPI-005571?style=for-the-badge&logo=fastapi", "name": "FastAPI"},
    "express": {"badge": "https://img.shields.io/badge/express.js-%23404d59.svg?style=for-the-badge&logo=express&logoColor=%2361DAFB", "name": "Express.js"},
    "express.js": {"badge": "https://img.shields.io/badge/express.js-%23404d59.svg?style=for-the-badge&logo=express&logoColor=%2361DAFB", "name": "Express.js"},
    "nestjs": {"badge": "https://img.shields.io/badge/nestjs-%23E0234E.svg?style=for-the-badge&logo=nestjs&logoColor=white", "name": "NestJS"},
    "spring": {"badge": "https://img.shields.io/badge/spring-%236DB33F.svg?style=for-the-badge&logo=spring&logoColor=white", "name": "Spring"},
    "spring boot": {"badge": "https://img.shields.io/badge/spring%20boot-%236DB33F.svg?style=for-the-badge&logo=springboot&logoColor=white", "name": "Spring Boot"},
    "laravel": {"badge": "https://img.shields.io/badge/laravel-%23FF2D20.svg?style=for-the-badge&logo=laravel&logoColor=white", "name": "Laravel"},
    "rails": {"badge": "https://img.shields.io/badge/rails-%23CC0000.svg?style=for-the-badge&logo=ruby-on-rails&logoColor=white", "name": "Rails"},

    # Databases
    "mongodb": {"badge": "https://img.shields.io/badge/MongoDB-%234ea94b.svg?style=for-the-badge&logo=mongodb&logoColor=white", "name": "MongoDB"},
    "postgresql": {"badge": "https://img.shields.io/badge/postgres-%23316192.svg?style=for-the-badge&logo=postgresql&logoColor=white", "name": "PostgreSQL"},
    "mysql": {"badge": "https://img.shields.io/badge/mysql-4479A1.svg?style=for-the-badge&logo=mysql&logoColor=white", "name": "MySQL"},
    "sqlite": {"badge": "https://img.shields.io/badge/sqlite-%2307405e.svg?style=for-the-badge&logo=sqlite&logoColor=white", "name": "SQLite"},
    "redis": {"badge": "https://img.shields.io/badge/redis-%23DD0031.svg?style=for-the-badge&logo=redis&logoColor=white", "name": "Redis"},
    "firebase": {"badge": "https://img.shields.io/badge/firebase-a08021?style=for-the-badge&logo=firebase&logoColor=ffcd34", "name": "Firebase"},
    "supabase": {"badge": "https://img.shields.io/badge/Supabase-3ECF8E?style=for-the-badge&logo=supabase&logoColor=white", "name": "Supabase"},
    "mariadb": {"badge": "https://img.shields.io/badge/MariaDB-003545?style=for-the-badge&logo=mariadb&logoColor=white", "name": "MariaDB"},

    # CSS Frameworks
    "tailwind": {"badge": "https://img.shields.io/badge/tailwindcss-%2338B2AC.svg?style=for-the-badge&logo=tailwind-css&logoColor=white", "name": "TailwindCSS"},
    "tailwindcss": {"badge": "https://img.shields.io/badge/tailwindcss-%2338B2AC.svg?style=for-the-badge&logo=tailwind-css&logoColor=white", "name": "TailwindCSS"},
    "bootstrap": {"badge": "https://img.shields.io/badge/bootstrap-%238511FA.svg?style=for-the-badge&logo=bootstrap&logoColor=white", "name": "Bootstrap"},
    "sass": {"badge": "https://img.shields.io/badge/SASS-hotpink.svg?style=for-the-badge&logo=SASS&logoColor=white", "name": "Sass"},
    "scss": {"badge": "https://img.shields.io/badge/SASS-hotpink.svg?style=for-the-badge&logo=SASS&logoColor=white", "name": "Sass"},
    "material-ui": {"badge": "https://img.shields.io/badge/MUI-%230081CB.svg?style=for-the-badge&logo=mui&logoColor=white", "name": "Material-UI"},
    "chakra": {"badge": "https://img.shields.io/badge/chakra-%234ED1C5.svg?style=for-the-badge&logo=chakraui&logoColor=white", "name": "Chakra UI"},
    "ant design": {"badge": "https://img.shields.io/badge/-AntDesign-%230170FE?style=for-the-badge&logo=ant-design&logoColor=white", "name": "Ant Design"},

    # Machine Learning / Data Science
    "tensorflow": {"badge": "https://img.shields.io/badge/TensorFlow-%23FF6F00.svg?style=for-the-badge&logo=TensorFlow&logoColor=white", "name": "TensorFlow"},
    "pytorch": {"badge": "https://img.shields.io/badge/PyTorch-%23EE4C2C.svg?style=for-the-badge&logo=PyTorch&logoColor=white", "name": "PyTorch"},
    "keras": {"badge": "https://img.shields.io/badge/Keras-%23D00000.svg?style=for-the-badge&logo=Keras&logoColor=white", "name": "Keras"},
    "scikit-learn": {"badge": "https://img.shields.io/badge/scikit--learn-%23F7931E.svg?style=for-the-badge&logo=scikit-learn&logoColor=white", "name": "Scikit-learn"},
    "pandas": {"badge": "https://img.shields.io/badge/pandas-%23150458.svg?style=for-the-badge&logo=pandas&logoColor=white", "name": "Pandas"},
    "numpy": {"badge": "https://img.shields.io/badge/numpy-%23013243.svg?style=for-the-badge&logo=numpy&logoColor=white", "name": "NumPy"},
    "matplotlib": {"badge": "https://img.shields.io/badge/Matplotlib-%23ffffff.svg?style=for-the-badge&logo=Matplotlib&logoColor=black", "name": "Matplotlib"},
    "jupyter": {"badge": "https://img.shields.io/badge/jupyter-%23FA0F00.svg?style=for-the-badge&logo=jupyter&logoColor=white", "name": "Jupyter"},

    # Cloud / DevOps
    "docker": {"badge": "https://img.shields.io/badge/docker-%230db7ed.svg?style=for-the-badge&logo=docker&logoColor=white", "name": "Docker"},
    "kubernetes": {"badge": "https://img.shields.io/badge/kubernetes-%23326ce5.svg?style=for-the-badge&logo=kubernetes&logoColor=white", "name": "Kubernetes"},
    "aws": {"badge": "https://img.shields.io/badge/AWS-%23FF9900.svg?style=for-the-badge&logo=amazon-aws&logoColor=white", "name": "AWS"},
    "azure": {"badge": "https://img.shields.io/badge/azure-%230072C6.svg?style=for-the-badge&logo=microsoftazure&logoColor=white", "name": "Azure"},
    "gcp": {"badge": "https://img.shields.io/badge/GoogleCloud-%234285F4.svg?style=for-the-badge&logo=google-cloud&logoColor=white", "name": "Google Cloud"},
    "terraform": {"badge": "https://img.shields.io/badge/terraform-%235835CC.svg?style=for-the-badge&logo=terraform&logoColor=white", "name": "Terraform"},
    "jenkins": {"badge": "https://img.shields.io/badge/jenkins-%232C5263.svg?style=for-the-badge&logo=jenkins&logoColor=white", "name": "Jenkins"},
    "github actions": {"badge": "https://img.shields.io/badge/github%20actions-%232671E5.svg?style=for-the-badge&logo=githubactions&logoColor=white", "name": "GitHub Actions"},
    "nginx": {"badge": "https://img.shields.io/badge/nginx-%23009639.svg?style=for-the-badge&logo=nginx&logoColor=white", "name": "Nginx"},

    # Mobile
    "react native": {"badge": "https://img.shields.io/badge/react_native-%2320232a.svg?style=for-the-badge&logo=react&logoColor=%2361DAFB", "name": "React Native"},
    "flutter": {"badge": "https://img.shields.io/badge/Flutter-%2302569B.svg?style=for-the-badge&logo=Flutter&logoColor=white", "name": "Flutter"},
    "expo": {"badge": "https://img.shields.io/badge/expo-1C1E24?style=for-the-badge&logo=expo&logoColor=#D04A37", "name": "Expo"},

    # Testing
    "jest": {"badge": "https://img.shields.io/badge/-jest-%23C21325?style=for-the-badge&logo=jest&logoColor=white", "name": "Jest"},
    "pytest": {"badge": "https://img.shields.io/badge/pytest-%23ffffff.svg?style=for-the-badge&logo=pytest&logoColor=2f9fe3", "name": "Pytest"},
    "cypress": {"badge": "https://img.shields.io/badge/-cypress-%23E5E5E5?style=for-the-badge&logo=cypress&logoColor=058a5e", "name": "Cypress"},
    "selenium": {"badge": "https://img.shields.io/badge/-selenium-%43B02A?style=for-the-badge&logo=selenium&logoColor=white", "name": "Selenium"},

    # Build Tools
    "webpack": {"badge": "https://img.shields.io/badge/webpack-%238DD6F9.svg?style=for-the-badge&logo=webpack&logoColor=black", "name": "Webpack"},
    "vite": {"badge": "https://img.shields.io/badge/vite-%23646CFF.svg?style=for-the-badge&logo=vite&logoColor=white", "name": "Vite"},
    "rollup": {"badge": "https://img.shields.io/badge/RollupJS-ef3335?style=for-the-badge&logo=rollup.js&logoColor=white", "name": "Rollup"},

    # ORM / Database Tools
    "prisma": {"badge": "https://img.shields.io/badge/Prisma-3982CE?style=for-the-badge&logo=Prisma&logoColor=white", "name": "Prisma"},
    "typeorm": {"badge": "https://img.shields.io/badge/TypeORM-FE0803?style=for-the-badge&logo=typeorm&logoColor=white", "name": "TypeORM"},
    "sequelize": {"badge": "https://img.shields.io/badge/Sequelize-52B0E7?style=for-the-badge&logo=Sequelize&logoColor=white", "name": "Sequelize"},
    "hibernate": {"badge": "https://img.shields.io/badge/Hibernate-59666C?style=for-the-badge&logo=Hibernate&logoColor=white", "name": "Hibernate"},

    # Other
    "graphql": {"badge": "https://img.shields.io/badge/-GraphQL-E10098?style=for-the-badge&logo=graphql&logoColor=white", "name": "GraphQL"},
    "rest api": {"badge": "https://img.shields.io/badge/REST-02569B?style=for-the-badge&logo=rest&logoColor=white", "name": "REST API"},
    "websocket": {"badge": "https://img.shields.io/badge/websocket-010101?style=for-the-badge&logo=socketdotio&logoColor=white", "name": "WebSocket"},
    "node.js": {"badge": "https://img.shields.io/badge/node.js-6DA55F?style=for-the-badge&logo=node.js&logoColor=white", "name": "Node.js"},
    "deno": {"badge": "https://img.shields.io/badge/deno%20js-000000?style=for-the-badge&logo=deno&logoColor=white", "name": "Deno"},
    "electron": {"badge": "https://img.shields.io/badge/Electron-191970?style=for-the-badge&logo=Electron&logoColor=white", "name": "Electron"},
    "socket.io": {"badge": "https://img.shields.io/badge/Socket.io-black?style=for-the-badge&logo=socket.io&badgeColor=010101", "name": "Socket.io"},
}


# List of valid tech keywords (lowercase) - used to filter out non-tech tags
VALID_TECH_KEYWORDS = set([
    # Languages
    "python", "javascript", "typescript", "java", "c", "c++", "c#", "go", "rust", "ruby",
    "php", "swift", "kotlin", "dart", "r", "scala", "shell", "bash", "lua", "perl", "haskell",
    "elixir", "clojure", "erlang", "julia", "matlab", "octave",

    # Frontend
    "react", "vue", "vue.js", "angular", "svelte", "next.js", "nuxt", "gatsby", "html", "css",
    "jsx", "tsx", "jquery", "backbone", "ember", "preact", "alpine.js",

    # Backend
    "django", "flask", "fastapi", "express", "express.js", "nestjs", "spring", "spring boot",
    "laravel", "rails", "asp.net", ".net", "node.js", "nodejs", "deno", "fastify",

    # Databases
    "mongodb", "postgresql", "postgres", "mysql", "sqlite", "redis", "firebase", "supabase",
    "mariadb", "dynamodb", "cassandra", "neo4j", "elasticsearch", "couchdb", "influxdb",

    # CSS Frameworks & Preprocessors
    "tailwind", "tailwindcss", "bootstrap", "sass", "scss", "less", "postcss", "styled-components",
    "material-ui", "mui", "chakra", "ant design", "bulma", "foundation", "semantic-ui",

    # ML / Data Science
    "tensorflow", "pytorch", "keras", "scikit-learn", "sklearn", "pandas", "numpy", "matplotlib",
    "seaborn", "plotly", "jupyter", "notebook", "opencv", "spacy", "nltk", "transformers",
    "huggingface", "xgboost", "lightgbm", "catboost",

    # Cloud / DevOps
    "docker", "kubernetes", "k8s", "aws", "azure", "gcp", "terraform", "ansible", "jenkins",
    "github actions", "gitlab ci", "circleci", "travis ci", "nginx", "apache", "caddy",

    # Mobile
    "react native", "flutter", "expo", "ionic", "cordova", "xamarin", "android", "ios",

    # Testing
    "jest", "pytest", "mocha", "chai", "jasmine", "cypress", "selenium", "playwright",
    "testing-library", "enzyme", "vitest", "unittest", "nose",

    # Build Tools
    "webpack", "vite", "rollup", "parcel", "esbuild", "gulp", "grunt", "babel",

    # ORM / Database Tools
    "prisma", "typeorm", "sequelize", "mongoose", "sqlalchemy", "hibernate", "room",

    # State Management
    "redux", "mobx", "zustand", "recoil", "jotai", "vuex", "pinia", "context api",

    # API / Communication
    "graphql", "rest", "rest api", "grpc", "websocket", "socket.io", "axios", "fetch",
    "apollo", "relay", "swagger", "openapi",

    # Package Managers
    "npm", "yarn", "pnpm", "pip", "poetry", "conda", "maven", "gradle", "cargo", "composer",

    # Version Control
    "git", "github", "gitlab", "bitbucket", "svn", "mercurial",

    # Other Important Tech
    "electron", "pwa", "service worker", "webassembly", "wasm", "serverless", "lambda",
    "cloudflare", "vercel", "netlify", "heroku", "digitalocean", "linode",
    "rabbitmq", "kafka", "mqtt", "celery", "bull", "agenda",
])


def is_valid_tech(tag: str) -> bool:
    """
    Check if a tag is a valid technology/framework
    Filters out project-specific tags like "breast-cancer", "todo-app", etc.
    """
    tag_lower = tag.lower().strip()

    # Direct match
    if tag_lower in VALID_TECH_KEYWORDS:
        return True

    # Check if it's a composite tech name (e.g., "spring-boot")
    tag_parts = tag_lower.replace("-", " ").replace("_", " ").split()
    composite = " ".join(tag_parts)
    if composite in VALID_TECH_KEYWORDS:
        return True

    # Check if any part is a known tech (helps with variations like "react-native")
    for part in tag_parts:
        # Avoid short false positives
        if part in VALID_TECH_KEYWORDS and len(part) > 2:
            return True

    return False


def get_badge_markdown(tech: str) -> str:
    """
    Get shield.io badge markdown for a technology
    Returns markdown string for the badge or None if not found
    """
    tech_lower = tech.lower().strip()

    # Direct lookup
    if tech_lower in TECH_STACK_BADGES:
        badge_info = TECH_STACK_BADGES[tech_lower]
        return f"![{badge_info['name']}]({badge_info['badge']})"

    # Try composite names
    tech_normalized = tech_lower.replace("_", " ").replace("-", " ")
    if tech_normalized in TECH_STACK_BADGES:
        badge_info = TECH_STACK_BADGES[tech_normalized]
        return f"![{badge_info['name']}]({badge_info['badge']})"

    return None


def generate_tech_stack_badges(tech_stack: list) -> str:
    """
    Generate markdown badges section for a list of technologies
    Only includes valid tech (filters out project-specific tags)
    """
    if not tech_stack:
        return ""

    # Filter and validate tech stack
    valid_tech = [tech for tech in tech_stack if is_valid_tech(tech)]

    if not valid_tech:
        return ""

    # Generate badges
    badges = []
    for tech in valid_tech[:15]:  # Limit to top 15 to avoid cluttering
        badge = get_badge_markdown(tech)
        if badge:
            badges.append(badge)

    if not badges:
        return ""

    # Format badges in markdown
    badges_md = " ".join(badges)
    return f"\n\n## ğŸ› ï¸ Tech Stack\n\n{badges_md}\n"
